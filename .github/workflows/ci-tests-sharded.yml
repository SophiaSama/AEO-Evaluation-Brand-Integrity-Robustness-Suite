name: BIRS CI - Tests (Sharded)

on:
  push:
    branches: [main, develop, feat/*, fix/*]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      shard-count:
        description: 'Number of shards (parallel jobs)'
        required: false
        default: '4'
        type: choice
        options:
          - '2'
          - '4'
          - '6'
          - '8'

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  # Pre-job to determine optimal shard count based on test files
  test-matrix-setup:
    name: Setup Test Matrix
    runs-on: ubuntu-latest
    outputs:
      shard-count: ${{ steps.calculate.outputs.shard-count }}
      test-groups: ${{ steps.calculate.outputs.test-groups }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Calculate optimal shards
        id: calculate
        shell: bash
        run: |
          # Don't use -u since GitHub Actions templates can be undefined
          set -eo pipefail

          # Use Python for counting + JSON generation (avoids pipefail edge cases)
          TEST_COUNT=$(python3 -c "from pathlib import Path; print(len(list(Path('tests').glob('test_*.py'))))")
          echo "Found $TEST_COUNT test files"

          # Handle optional workflow_dispatch input; default to empty for push/PR triggers
          INPUT_SHARDS=''
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INPUT_SHARDS="${{ github.event.inputs.shard-count }}"
          fi

          if [ -n "$INPUT_SHARDS" ]; then
            SHARD_COUNT="$INPUT_SHARDS"
          else
            SHARD_COUNT=$((TEST_COUNT / 2))
            if [ "$SHARD_COUNT" -lt 2 ]; then
              SHARD_COUNT=2
            elif [ "$SHARD_COUNT" -gt 4 ]; then
              SHARD_COUNT=4
            fi
          fi

          echo "DEBUG: SHARD_COUNT=$SHARD_COUNT"
          
          # Generate test groups JSON array [1,2,...,n] using bash
          # Important: No spaces in JSON for GitHub Actions compatibility
          GROUPS="["
          for i in $(seq 1 $SHARD_COUNT); do
            if [ $i -gt 1 ]; then
              GROUPS="${GROUPS},"
            fi
            GROUPS="${GROUPS}${i}"
          done
          GROUPS="${GROUPS}]"
          
          echo "Using $SHARD_COUNT shards"
          echo "Generated test groups: $GROUPS"

          # Verify GITHUB_OUTPUT is set
          if [ -z "$GITHUB_OUTPUT" ]; then
            echo "ERROR: GITHUB_OUTPUT is not set"
            exit 1
          fi
          
          echo "DEBUG: GITHUB_OUTPUT=$GITHUB_OUTPUT"
          echo "DEBUG: Writing outputs to GITHUB_OUTPUT"
          echo "DEBUG: test-groups value: $GROUPS"

          # Write outputs with proper GitHub Actions format
          # Use simple single-line format for JSON array
          {
            echo "shard-count=$SHARD_COUNT"
            echo "test-groups=$GROUPS"
          } >> "$GITHUB_OUTPUT"
          
          echo "DEBUG: Successfully wrote outputs"
          
          # Verify what was written
          echo "DEBUG: Contents of outputs:"
          echo "  shard-count=$SHARD_COUNT"
          echo "  test-groups=$GROUPS"

  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black flake8 mypy isort
          pip install -r requirements.txt

      - name: Run isort (import sort check)
        run: isort --check-only src/ tests/ scripts/

      - name: Run Black (format check)
        run: black --check src/ tests/ scripts/

      - name: Run Flake8 (linting)
        run: flake8 src/ tests/ scripts/ --max-line-length=120 --extend-ignore=E203,W503

      - name: Run mypy (type checking)
        run: mypy src/ --ignore-missing-imports
        continue-on-error: true

  unit-tests-sharded:
    name: Unit Tests Shard ${{ matrix.shard }}/${{ needs.test-matrix-setup.outputs.shard-count }} (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: test-matrix-setup
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']
        shard: ${{ fromJson(needs.test-matrix-setup.outputs.test-groups) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist pytest-split

      - name: Verify test environment
        run: |
          echo "Python version:"
          python --version
          echo "Pytest version:"
          pytest --version
          echo "Pytest plugins:"
          pytest --version --verbose
          echo "Test files:"
          ls -la tests/test_*.py || echo "No test files found"

      - name: Cache test durations
        uses: actions/cache@v4
        with:
          path: .test_durations
          key: test-durations-${{ matrix.python-version }}-${{ hashFiles('tests/**/*.py') }}
          restore-keys: |
            test-durations-${{ matrix.python-version }}-
            test-durations-

      - name: Run tests (shard ${{ matrix.shard }}/${{ needs.test-matrix-setup.outputs.shard-count }})
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          # Do NOT use set -e here â€” we need to capture pytest's exit code
          echo "Running tests for shard ${{ matrix.shard }}/${{ needs.test-matrix-setup.outputs.shard-count }} on Python ${{ matrix.python-version }}"
          pytest tests/ -v \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml:coverage-shard-${{ matrix.shard }}.xml \
            --cov-report=html:htmlcov-shard-${{ matrix.shard }} \
            --splits ${{ needs.test-matrix-setup.outputs.shard-count }} \
            --group ${{ matrix.shard }} \
            --store-durations \
            --durations-path=.test_durations \
            -m "not integration and not e2e" || code=$?
          code=${code:-0}
          echo "Pytest exit code: $code"
          if [ "$code" -eq 5 ]; then
            echo "No tests selected for this shard (pytest exit 5); treating as success."
            exit 0
          elif [ "$code" -ne 0 ]; then
            echo "Tests failed with exit code $code"
            exit "$code"
          else
            echo "Tests passed"
            exit 0
          fi

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-shard-${{ matrix.shard }}-py${{ matrix.python-version }}
          path: |
            coverage-shard-${{ matrix.shard }}.xml
            htmlcov-shard-${{ matrix.shard }}/
          retention-days: 7

      - name: Upload test durations
        if: matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: test-durations-shard-${{ matrix.shard }}
          path: .test_durations
          retention-days: 30

  # Merge coverage reports from all shards
  coverage-merge:
    name: Merge Coverage Reports
    runs-on: ubuntu-latest
    needs: unit-tests-sharded
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install coverage tools
        run: |
          python -m pip install --upgrade pip
          pip install coverage[toml]

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-shard-*-py3.11
          path: coverage-artifacts/

      - name: Merge coverage reports
        run: |
          # Combine all coverage XML files
          coverage combine coverage-artifacts/*/coverage-*.xml || true
          coverage xml -o coverage-merged.xml || true
          coverage html -d htmlcov-merged || true
          coverage report || true

      - name: Upload merged coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage-merged.xml
          flags: unittests-sharded
          name: codecov-sharded
        continue-on-error: true

      - name: Archive merged coverage report
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage-merged
          path: htmlcov-merged/
          retention-days: 30

      - name: Comment coverage summary on PR
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          COVERAGE_PATH: coverage-merged.xml
        continue-on-error: true

  # Integration tests (not sharded - typically fewer and longer running)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run integration tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pytest tests/ -v \
            --cov=src \
            --cov-report=term-missing \
            --cov-report=xml:coverage-integration.xml \
            -m "integration"
        continue-on-error: true

      - name: Upload integration coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-integration
          path: coverage-integration.xml
        continue-on-error: true

  # Summary job that requires all shards to pass
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, unit-tests-sharded, integration-tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "Lint: ${{ needs.lint.result }}"
          echo "Unit Tests (Sharded): ${{ needs.unit-tests-sharded.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"

          if [[ "${{ needs.lint.result }}" != "success" ]]; then
            echo "Linting failed"
            exit 1
          fi

          # unit-tests-shared is a matrix job; treat anything other than success as failure.
          # (If you later allow continue-on-error for specific shards, change this gate.)
          if [[ "${{ needs.unit-tests-sharded.result }}" != "success" ]]; then
            echo "Unit tests failed (at least one shard failed or was cancelled)"
            exit 1
          fi

          if [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
            echo "Integration tests failed (non-blocking)"
          fi

          echo "All required tests passed!"

  structure-validation:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate required directories exist
        run: |
          for dir in src tests docs data scripts .github/workflows; do
            if [ ! -d "$dir" ]; then
              echo "Missing required directory: $dir"
              exit 1
            fi
          done
          echo "All required directories present"

      - name: Validate required files exist
        run: |
          for file in README.md requirements.txt src/config.py src/rag.py; do
            if [ ! -f "$file" ]; then
              echo "Missing required file: $file"
              exit 1
            fi
          done
          echo "All required files present"
