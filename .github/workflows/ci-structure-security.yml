name: BIRS CI - Structure & Security

on:
  push:
    branches: [main, develop, feat/*, fix/*]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  structure-validation:
    name: Validate Project Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate documents.json structure
        run: |
          python -c "
          import json
          from pathlib import Path
          
          docs_json = Path('data/documents/documents.json')
          if docs_json.exists():
              data = json.loads(docs_json.read_text())
              assert 'clean' in data, 'Missing clean array'
              assert 'poison' in data, 'Missing poison array'
              assert len(data['clean']) > 0, 'Clean docs empty'
              assert len(data['poison']) > 0, 'Poison docs empty'
              print(f'✓ documents.json valid: {len(data[\"clean\"])} clean + {len(data[\"poison\"])} poison')
          else:
              print('⚠ documents.json not found (will be generated)')
          "

      - name: Validate ground truth structure
        run: |
          python -c "
          import json
          from pathlib import Path
          
          gt_json = Path('data/ground_truth/brands.json')
          if gt_json.exists():
              data = json.loads(gt_json.read_text())
              for brand, info in data.items():
                  assert 'name' in info, f'Brand {brand} missing name'
                  assert 'website' in info, f'Brand {brand} missing website'
              print(f'✓ ground_truth/brands.json valid: {len(data)} brands')
          else:
              print('⚠ ground_truth/brands.json not found')
          "

      - name: Check required files
        run: |
          files=(
            "src/config.py"
            "src/rag.py"
            "src/test_cases.py"
            "src/scoring.py"
            "src/baseline.py"
            "src/run_suite.py"
            "src/entity_validator.py"
            "src/citation_verifier.py"
            "scripts/ingest_documents.py"
            "scripts/crawl_brand.py"
            "requirements.txt"
          )
          
          missing=0
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "✗ Missing: $file"
              missing=$((missing + 1))
            else
              echo "✓ Found: $file"
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "Error: $missing required files missing"
            exit 1
          fi
          
          echo "✓ All required files present"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit

      - name: Run Safety (dependency vulnerability scan)
        run: safety check --json || true
        continue-on-error: true

      - name: Run Bandit (security linter)
        run: bandit -r src/ -f json -o bandit-report.json || true
        continue-on-error: true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [structure-validation, security-scan]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "## BIRS CI Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Structure Validation | ${{ needs.structure-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
