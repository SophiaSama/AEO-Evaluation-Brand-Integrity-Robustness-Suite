# Migration to JSON-Only Workflow

## Changes Made (February 6, 2026)

### Summary
The project has been migrated from a `.txt` file-based workflow to a single JSON file workflow for better maintainability and version control.

## What Changed

### ‚úÖ Added
- **`scripts/ingest_documents.py`** - New script that reads from `documents.json` and populates ChromaDB
  - Creates `birs_clean` collection (5 truthful documents)
  - Creates `birs_poisoned` collection (5 clean + 15 poison documents)
  - Uses `sentence-transformers` for embeddings
  - Shows progress and provides clear next-step instructions

### üìù Updated
- **`README.md`** - Updated workflow documentation:
  - Crawler now updates `documents.json` directly
  - Removed references to fallback `.txt` files
  - Clarified that `clean/` and `poison/` directories are now empty (legacy)
  - Updated project structure diagram

- **`docs/BIRS_PLAN.md`** - Updated architecture documentation:
  - Documents stored in single `documents.json` file
  - Updated repository structure
  - Clarified data ingestion process

- **`src/config.py`** - Updated comments to reflect new structure:
  - `DOCUMENTS_JSON` is now the single source of truth
  - `CLEAN_DIR` and `POISON_DIR` marked as legacy

- **`scripts/build_documents_json.py`** - Marked as legacy:
  - Added warning message when executed
  - Still functional for backward compatibility if needed
  - Checks for empty directories before attempting conversion

- **`.env.example`** - Added new optional variable:
  - `BIRS_BRAND_NAME` to configure the brand being tested

### üóëÔ∏è Deprecated
- **`.txt` files in `clean/` and `poison/` directories** - No longer used
  - Directories kept for backward compatibility but are empty
  - All document data now managed through `documents.json`

## New Workflow

### Standard Usage
1. **(Optional)** Crawl real brand data:
   ```bash
   python scripts/crawl_brand.py --brand Manus --max-docs 5
   ```
   This updates `data/documents/documents.json` with new clean content.

2. **Ingest documents into ChromaDB:**
   ```bash
   python scripts/ingest_documents.py
   ```
   This reads from `documents.json` and creates both collections.

3. **Run the test suite:**
   ```bash
   python -m src.run_suite
   ```

### Editing Documents
To add/modify documents, edit `data/documents/documents.json` directly:

```json
{
  "clean": [
    {
      "id": "unique_id",
      "source": "source_filename.txt",
      "source_name": "official",
      "content": "Document content here..."
    }
  ],
  "poison": [
    {
      "id": "unique_id",
      "source": "source_filename.txt",
      "source_name": "reddit",
      "content": "False document content here..."
    }
  ]
}
```

After editing, run `python scripts/ingest_documents.py` to update ChromaDB.

## Benefits of New Approach

‚úÖ **Single Source of Truth** - All documents in one file
‚úÖ **Version Control Friendly** - JSON diffs are clear and trackable
‚úÖ **Easier Maintenance** - No need to manage 20+ separate `.txt` files
‚úÖ **Structured Metadata** - Each document has consistent metadata fields
‚úÖ **Simpler Workflow** - One command to ingest all data

## Backward Compatibility

The `scripts/build_documents_json.py` script is still available if you have existing `.txt` files that need to be converted to the new format. However, in normal operation, this script is no longer needed.

## Migration for Existing Users

If you were using the old `.txt` file workflow:

1. Your existing `documents.json` already contains all the data
2. Delete (or keep as empty) the `.txt` files in `clean/` and `poison/`
3. Use the new `scripts/ingest_documents.py` to populate ChromaDB
4. Continue with normal workflow

## Files Structure

```
data/
‚îú‚îÄ‚îÄ documents/
‚îÇ   ‚îú‚îÄ‚îÄ documents.json     ‚Üê Single source of truth
‚îÇ   ‚îú‚îÄ‚îÄ clean/             ‚Üê Empty (legacy)
‚îÇ   ‚îî‚îÄ‚îÄ poison/            ‚Üê Empty (legacy)
‚îî‚îÄ‚îÄ chroma_birs/           ‚Üê Generated by ingest_documents.py
```
